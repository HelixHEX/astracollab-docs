---
title: 'Authentication'
description: 'Learn how to integrate AstraCollab authentication into your applications'
---

## Authentication

Integrate AstraCollab authentication into your applications using API keys, OAuth, or custom authentication flows.

## API Key Authentication

### Basic Integration

The simplest way to authenticate with AstraCollab is using API keys:

```javascript
import { AstraCollab } from '@astracollab/sdk';

// Initialize client with API key
const client = new AstraCollab('your-api-key-here');

// Make authenticated requests
const files = await client.files.list();
```

### Environment-Based Configuration

Configure API keys for different environments:

```javascript
// config/auth.js
const getApiKey = () => {
  switch (process.env.NODE_ENV) {
    case 'production':
      return process.env.ASTRACOLLAB_PROD_API_KEY;
    case 'staging':
      return process.env.ASTRACOLLAB_STAGING_API_KEY;
    case 'development':
      return process.env.ASTRACOLLAB_DEV_API_KEY;
    default:
      throw new Error('Invalid environment');
  }
};

// Initialize client
const client = new AstraCollab(getApiKey());
```

### Key Rotation Strategy

Implement automatic key rotation:

```javascript
class AstraCollabClient {
  constructor() {
    this.client = null;
    this.keyRotationInterval = null;
  }

  async initialize() {
    await this.refreshClient();
    this.startKeyRotation();
  }

  async refreshClient() {
    const apiKey = await this.getCurrentApiKey();
    this.client = new AstraCollab(apiKey);
  }

  async getCurrentApiKey() {
    // Fetch from secure key management service
    const response = await fetch('/api/keys/current');
    const { apiKey } = await response.json();
    return apiKey;
  }

  startKeyRotation() {
    // Rotate keys every 30 days
    this.keyRotationInterval = setInterval(async () => {
      await this.refreshClient();
    }, 30 * 24 * 60 * 60 * 1000);
  }

  stopKeyRotation() {
    if (this.keyRotationInterval) {
      clearInterval(this.keyRotationInterval);
    }
  }
}
```

## OAuth Integration

### OAuth 2.0 Flow

Integrate OAuth for user-based authentication:

```javascript
// OAuth configuration
const oauthConfig = {
  clientId: process.env.ASTRACOLLAB_CLIENT_ID,
  clientSecret: process.env.ASTRACOLLAB_CLIENT_SECRET,
  redirectUri: 'https://yourapp.com/auth/callback',
  scope: 'files:read files:write folders:read'
};

// Step 1: Redirect user to authorization URL
const getAuthUrl = () => {
  const params = new URLSearchParams({
    client_id: oauthConfig.clientId,
    redirect_uri: oauthConfig.redirectUri,
    scope: oauthConfig.scope,
    response_type: 'code',
    state: generateRandomState()
  });

  return `https://auth.astracollab.com/oauth/authorize?${params}`;
};

// Step 2: Handle authorization callback
const handleAuthCallback = async (code, state) => {
  const tokenResponse = await fetch('https://auth.astracollab.com/oauth/token', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: new URLSearchParams({
      grant_type: 'authorization_code',
      client_id: oauthConfig.clientId,
      client_secret: oauthConfig.clientSecret,
      code,
      redirect_uri: oauthConfig.redirectUri
    })
  });

  const { access_token, refresh_token, expires_in } = await tokenResponse.json();
  
  // Store tokens securely
  await storeTokens({ access_token, refresh_token, expires_in });
  
  return access_token;
};

// Step 3: Use access token
const client = new AstraCollab(access_token);
```

### Token Management

Manage OAuth tokens securely:

```javascript
class TokenManager {
  constructor() {
    this.accessToken = null;
    this.refreshToken = null;
    this.expiresAt = null;
  }

  async loadTokens() {
    // Load from secure storage
    const tokens = await this.getStoredTokens();
    if (tokens) {
      this.accessToken = tokens.access_token;
      this.refreshToken = tokens.refresh_token;
      this.expiresAt = new Date(tokens.expires_at);
    }
  }

  async getValidToken() {
    if (!this.accessToken) {
      throw new Error('No access token available');
    }

    // Check if token is expired (with 5-minute buffer)
    if (this.expiresAt && new Date() > new Date(this.expiresAt.getTime() - 5 * 60 * 1000)) {
      await this.refreshAccessToken();
    }

    return this.accessToken;
  }

  async refreshAccessToken() {
    if (!this.refreshToken) {
      throw new Error('No refresh token available');
    }

    const response = await fetch('https://auth.astracollab.com/oauth/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams({
        grant_type: 'refresh_token',
        client_id: oauthConfig.clientId,
        client_secret: oauthConfig.clientSecret,
        refresh_token: this.refreshToken
      })
    });

    const { access_token, refresh_token, expires_in } = await response.json();
    
    this.accessToken = access_token;
    this.refreshToken = refresh_token;
    this.expiresAt = new Date(Date.now() + expires_in * 1000);
    
    await this.storeTokens();
  }

  async storeTokens() {
    // Store in secure storage
    const tokens = {
      access_token: this.accessToken,
      refresh_token: this.refreshToken,
      expires_at: this.expiresAt.toISOString()
    };
    
    await this.saveToSecureStorage(tokens);
  }
}
```

## Custom Authentication

### JWT Integration

Use JWT tokens for custom authentication:

```javascript
// JWT configuration
const jwtConfig = {
  secret: process.env.JWT_SECRET,
  issuer: 'your-app',
  audience: 'astracollab'
};

// Generate JWT token
const generateJWT = (userId, permissions) => {
  const payload = {
    sub: userId,
    iss: jwtConfig.issuer,
    aud: jwtConfig.audience,
    permissions,
    iat: Math.floor(Date.now() / 1000),
    exp: Math.floor(Date.now() / 1000) + (60 * 60) // 1 hour
  };

  return jwt.sign(payload, jwtConfig.secret);
};

// Verify JWT token
const verifyJWT = (token) => {
  try {
    const decoded = jwt.verify(token, jwtConfig.secret);
    return decoded;
  } catch (error) {
    throw new Error('Invalid JWT token');
  }
};

// Use JWT with AstraCollab
const client = new AstraCollab(jwtToken);
```

### Session-Based Authentication

Implement session-based authentication:

```javascript
// Session management
class SessionManager {
  constructor() {
    this.sessions = new Map();
  }

  createSession(userId, permissions) {
    const sessionId = crypto.randomUUID();
    const session = {
      userId,
      permissions,
      createdAt: new Date(),
      lastAccessed: new Date()
    };

    this.sessions.set(sessionId, session);
    return sessionId;
  }

  getSession(sessionId) {
    const session = this.sessions.get(sessionId);
    if (session) {
      session.lastAccessed = new Date();
      return session;
    }
    return null;
  }

  async getApiKeyForSession(sessionId) {
    const session = this.getSession(sessionId);
    if (!session) {
      throw new Error('Invalid session');
    }

    // Get or create API key for this session
    const apiKey = await this.getOrCreateApiKey(session.userId, session.permissions);
    return apiKey;
  }

  async getOrCreateApiKey(userId, permissions) {
    // Check if user already has an API key
    const existingKey = await this.findUserApiKey(userId);
    
    if (existingKey) {
      return existingKey;
    }

    // Create new API key
    const client = new AstraCollab(process.env.ADMIN_API_KEY);
    const newKey = await client.keys.create({
      name: `Session Key - ${userId}`,
      permissions,
      expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() // 24 hours
    });

    return newKey.fullKey;
  }
}
```

## Next.js Integration

### API Routes

Create API routes for authentication:

```typescript
// pages/api/auth/login.ts
import { NextApiRequest, NextApiResponse } from 'next';
import { AstraCollab } from '@astracollab/sdk';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { email, password } = req.body;

    // Authenticate user with your system
    const user = await authenticateUser(email, password);
    
    if (!user) {
      return res.status(401).json({ error: 'Invalid credentials' });
    }

    // Create AstraCollab API key for user
    const client = new AstraCollab(process.env.ADMIN_API_KEY);
    const apiKey = await client.keys.create({
      name: `User Key - ${user.id}`,
      permissions: user.permissions || ['files:read', 'files:write'],
      expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // 7 days
    });

    // Set session
    req.session.userId = user.id;
    req.session.apiKey = apiKey.fullKey;
    await req.session.save();

    res.json({ 
      success: true, 
      user: { id: user.id, email: user.email },
      apiKey: apiKey.fullKey 
    });

  } catch (error) {
    console.error('Login error:', error);
    res.status(500).json({ error: 'Authentication failed' });
  }
}
```

### Client-Side Integration

Use authentication in React components:

```typescript
// hooks/useAuth.ts
import { useState, useEffect } from 'react';
import { AstraCollab } from '@astracollab/sdk';

export function useAuth() {
  const [client, setClient] = useState<AstraCollab | null>(null);
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    checkAuth();
  }, []);

  const checkAuth = async () => {
    try {
      const response = await fetch('/api/auth/me');
      if (response.ok) {
        const { user, apiKey } = await response.json();
        setUser(user);
        setClient(new AstraCollab(apiKey));
      }
    } catch (error) {
      console.error('Auth check failed:', error);
    } finally {
      setLoading(false);
    }
  };

  const login = async (email: string, password: string) => {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    if (response.ok) {
      const { user, apiKey } = await response.json();
      setUser(user);
      setClient(new AstraCollab(apiKey));
      return true;
    }
    return false;
  };

  const logout = async () => {
    await fetch('/api/auth/logout', { method: 'POST' });
    setUser(null);
    setClient(null);
  };

  return { client, user, loading, login, logout };
}
```

### Protected Components

Create protected components that require authentication:

```typescript
// components/ProtectedComponent.tsx
import { useAuth } from '../hooks/useAuth';
import { useFiles } from '@astracollab/nextjs';

export function ProtectedComponent() {
  const { client, user, loading } = useAuth();
  const { files, isLoading, error } = useFiles({ client });

  if (loading) return <div>Loading...</div>;
  if (!user) return <div>Please log in</div>;
  if (error) return <div>Error: {error.message}</div>;

  return (
    <div>
      <h2>Welcome, {user.email}</h2>
      <h3>Your Files</h3>
      {isLoading ? (
        <div>Loading files...</div>
      ) : (
        <ul>
          {files.map(file => (
            <li key={file.id}>{file.name}</li>
          ))}
        </ul>
      )}
    </div>
  );
}
```

## Error Handling

### Authentication Errors

Handle authentication errors gracefully:

```javascript
class AuthErrorHandler {
  static handleError(error) {
    switch (error.code) {
      case 'INVALID_API_KEY':
        return this.handleInvalidKey();
      case 'API_KEY_EXPIRED':
        return this.handleExpiredKey();
      case 'INSUFFICIENT_PERMISSIONS':
        return this.handleInsufficientPermissions();
      case 'RATE_LIMITED':
        return this.handleRateLimit();
      default:
        return this.handleGenericError(error);
    }
  }

  static handleInvalidKey() {
    // Redirect to login or refresh token
    window.location.href = '/auth/login';
  }

  static handleExpiredKey() {
    // Attempt to refresh token
    return this.refreshToken();
  }

  static handleInsufficientPermissions() {
    // Show permission error
    return {
      type: 'error',
      message: 'You don\'t have permission to perform this action'
    };
  }

  static handleRateLimit() {
    // Show rate limit message
    return {
      type: 'warning',
      message: 'Rate limit exceeded. Please try again later.'
    };
  }

  static handleGenericError(error) {
    console.error('Authentication error:', error);
    return {
      type: 'error',
      message: 'An authentication error occurred'
    };
  }
}
```

## Security Best Practices

### Key Storage

Store API keys securely:

```javascript
// Secure key storage
const secureKeyStorage = {
  // Browser environment
  browser: {
    store: (key, value) => {
      // Use sessionStorage for temporary storage
      sessionStorage.setItem(key, value);
    },
    retrieve: (key) => {
      return sessionStorage.getItem(key);
    },
    remove: (key) => {
      sessionStorage.removeItem(key);
    }
  },

  // Node.js environment
  node: {
    store: (key, value) => {
      // Use environment variables or secure key management
      process.env[key] = value;
    },
    retrieve: (key) => {
      return process.env[key];
    },
    remove: (key) => {
      delete process.env[key];
    }
  }
};
```

### Token Validation

Validate tokens before use:

```javascript
const validateToken = (token) => {
  if (!token) {
    throw new Error('No token provided');
  }

  if (token.length < 20) {
    throw new Error('Invalid token format');
  }

  // Additional validation as needed
  return true;
};

const safeClientInit = (token) => {
  try {
    validateToken(token);
    return new AstraCollab(token);
  } catch (error) {
    console.error('Token validation failed:', error);
    throw error;
  }
};
```

## Testing Authentication

### Mock Authentication

Create mock authentication for testing:

```javascript
// test/mocks/auth.js
export const mockAuth = {
  apiKey: 'test_api_key_1234567890abcdef',
  user: {
    id: 'user_123',
    email: 'test@example.com',
    permissions: ['files:read', 'files:write']
  },
  
  createMockClient: () => {
    return new AstraCollab(mockAuth.apiKey);
  },
  
  mockLogin: async (email, password) => {
    if (email === 'test@example.com' && password === 'password') {
      return {
        success: true,
        user: mockAuth.user,
        apiKey: mockAuth.apiKey
      };
    }
    throw new Error('Invalid credentials');
  }
};
```

### Integration Tests

Test authentication integration:

```javascript
// test/integration/auth.test.js
import { AstraCollab } from '@astracollab/sdk';

describe('Authentication Integration', () => {
  test('should authenticate with valid API key', async () => {
    const client = new AstraCollab(process.env.TEST_API_KEY);
    const files = await client.files.list();
    expect(files).toBeDefined();
  });

  test('should reject invalid API key', async () => {
    const client = new AstraCollab('invalid_key');
    await expect(client.files.list()).rejects.toThrow();
  });

  test('should handle expired token', async () => {
    const client = new AstraCollab(expiredToken);
    await expect(client.files.list()).rejects.toThrow();
  });
});
```

## Best Practices Summary

### Security
- Store keys securely (environment variables, secure storage)
- Implement key rotation
- Use least privilege principle
- Validate tokens before use

### User Experience
- Handle authentication errors gracefully
- Provide clear error messages
- Implement automatic token refresh
- Support multiple authentication methods

### Development
- Use environment-specific configurations
- Implement comprehensive testing
- Monitor authentication failures
- Document authentication flows
